<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JPA 기본키 매핑 전략 | TIL : Today I Learned</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="매일 공부한 내용을 정리합니다.">
    
    <link rel="preload" href="/TIL/assets/css/0.styles.c403335a.css" as="style"><link rel="preload" href="/TIL/assets/js/app.3f1ab354.js" as="script"><link rel="preload" href="/TIL/assets/js/2.a63aa0a0.js" as="script"><link rel="preload" href="/TIL/assets/js/15.2dffbb21.js" as="script"><link rel="prefetch" href="/TIL/assets/js/10.7ca17b45.js"><link rel="prefetch" href="/TIL/assets/js/11.2de1aea3.js"><link rel="prefetch" href="/TIL/assets/js/12.56d7ecbc.js"><link rel="prefetch" href="/TIL/assets/js/13.73f75f66.js"><link rel="prefetch" href="/TIL/assets/js/14.d2271549.js"><link rel="prefetch" href="/TIL/assets/js/16.cb862edc.js"><link rel="prefetch" href="/TIL/assets/js/17.bb9eb875.js"><link rel="prefetch" href="/TIL/assets/js/18.3fecb728.js"><link rel="prefetch" href="/TIL/assets/js/19.ef326407.js"><link rel="prefetch" href="/TIL/assets/js/20.24e25134.js"><link rel="prefetch" href="/TIL/assets/js/21.364ae37d.js"><link rel="prefetch" href="/TIL/assets/js/22.194627d8.js"><link rel="prefetch" href="/TIL/assets/js/23.4b3bf695.js"><link rel="prefetch" href="/TIL/assets/js/24.6bd7e292.js"><link rel="prefetch" href="/TIL/assets/js/25.f17131fc.js"><link rel="prefetch" href="/TIL/assets/js/26.ca4999dc.js"><link rel="prefetch" href="/TIL/assets/js/27.a7d85057.js"><link rel="prefetch" href="/TIL/assets/js/28.0688db5e.js"><link rel="prefetch" href="/TIL/assets/js/29.e2696701.js"><link rel="prefetch" href="/TIL/assets/js/3.d644de53.js"><link rel="prefetch" href="/TIL/assets/js/30.0e188986.js"><link rel="prefetch" href="/TIL/assets/js/31.19f96a06.js"><link rel="prefetch" href="/TIL/assets/js/32.24aba17b.js"><link rel="prefetch" href="/TIL/assets/js/33.8a768618.js"><link rel="prefetch" href="/TIL/assets/js/34.b498cefd.js"><link rel="prefetch" href="/TIL/assets/js/35.512dfb96.js"><link rel="prefetch" href="/TIL/assets/js/36.a3787108.js"><link rel="prefetch" href="/TIL/assets/js/37.945d8cbf.js"><link rel="prefetch" href="/TIL/assets/js/38.a2ea3726.js"><link rel="prefetch" href="/TIL/assets/js/39.d4170ad4.js"><link rel="prefetch" href="/TIL/assets/js/4.394d85cc.js"><link rel="prefetch" href="/TIL/assets/js/40.275859a3.js"><link rel="prefetch" href="/TIL/assets/js/5.ba3bfe47.js"><link rel="prefetch" href="/TIL/assets/js/6.526393d5.js"><link rel="prefetch" href="/TIL/assets/js/7.f449d1c1.js"><link rel="prefetch" href="/TIL/assets/js/8.9159fc0b.js"><link rel="prefetch" href="/TIL/assets/js/9.a48c7260.js">
    <link rel="stylesheet" href="/TIL/assets/css/0.styles.c403335a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/TIL/" class="home-link router-link-active"><!----> <span class="site-name">TIL : Today I Learned</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/kim-jin-seop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://cnu-jinseop.tistory.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/kim-jin-seop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://cnu-jinseop.tistory.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HOME</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CS_Algorithm</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CS_DataBase</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JPA</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/TIL/JPA/2022-01-10.html" aria-current="page" class="active sidebar-link">JPA 기본키 매핑 전략</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/TIL/JPA/2022-01-10.html#직접할당" class="sidebar-link">직접할당</a></li><li class="sidebar-sub-header"><a href="/TIL/JPA/2022-01-10.html#자동생성" class="sidebar-link">자동생성</a></li></ul></li><li><a href="/TIL/JPA/2022-01-11.html" class="sidebar-link">JPA 단방향 연관관계</a></li><li><a href="/TIL/JPA/2022-01-12.html" class="sidebar-link">JPA 연관관계의 주인</a></li><li><a href="/TIL/JPA/2022-01-14.html" class="sidebar-link">JPA 양방향 연관관계</a></li><li><a href="/TIL/JPA/2022-01-15.html" class="sidebar-link">JPA 연관관계의 주인</a></li><li><a href="/TIL/JPA/2022-02-01.html" class="sidebar-link">지연로딩과 CASCADE</a></li><li><a href="/TIL/JPA/2022-02-03.html" class="sidebar-link">Value Type</a></li><li><a href="/TIL/JPA/2022-02-05.html" class="sidebar-link">Hello JPQL</a></li><li><a href="/TIL/JPA/2022-02-06.html" class="sidebar-link">JPQL 경로표현식과 묵시적 조인</a></li><li><a href="/TIL/JPA/2022-02-08.html" class="sidebar-link">페치조인의 기본</a></li><li><a href="/TIL/JPA/2022-02-09.html" class="sidebar-link">페치 조인 주의점!</a></li><li><a href="/TIL/JPA/2022-02-10.html" class="sidebar-link">JPQL에서 직접 객체 사용하기</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java8</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="jpa-기본키-매핑-전략"><a href="#jpa-기본키-매핑-전략" class="header-anchor">#</a> JPA 기본키 매핑 전략</h1> <p>JPA의 기본 키 매핑을 하는 방법은 annotation을 사용하면 된다.</p> <ul><li>@Id</li> <li>@GeneratedValue<br>
이렇게 두개의 annotation을 사용해주면 된다.</li></ul> <p>@Id만 사용하여 로직에서 생성되는  Id를 직접 할당해주는 방법이 있고, @GeneratedValue를 추가하여 자동으로 생성해주는 방법이 있다.</p> <h2 id="직접할당"><a href="#직접할당" class="header-anchor">#</a> 직접할당</h2> <p><strong>직접할당</strong> 방법은 말그대로 직접 Id값을 넣어주는 방법이다. DB에서 Primary Key 조건은 null이 아니고, 유일해야하며 변하면 안된다. 비즈니스에서 어떤 값을 id로 설정을하게 된다면 변하지 않아야한다는 조건을 지키기가 굉장히 힘들것이다. 따라서 대체로 의미없는 특정 값을 넣어 Id로 사용하는 것이 바람직하며 이를 DB가 자동생성해줄 수 있다.</p> <h2 id="자동생성"><a href="#자동생성" class="header-anchor">#</a> 자동생성</h2> <p>자동생성은 @GeneratedValue 어노테이션을 사용해주면된다. @GeneratedValue는 4가지 전략이 있다.</p> <ul><li>IDENTITY</li> <li>SEQUENCE</li> <li>TABLE</li> <li>AUTO</li></ul> <h3 id="identity"><a href="#identity" class="header-anchor">#</a> IDENTITY</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Member</span><span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Id</span>
	<span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>
	<span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>IDENTITY 전략은 기본키를 생성하는 것을 DB에게 작업을 넘겨주는 것이다. AUTO_INCREMENT라고하여 1씩 DB에서 증가시켜 넣어주며 INSERT SQL이 실행되는 시점에 ID를 넣어주게 된다.. 영속성 컨텍스트에서 객체를 엔티티로 관리받기 위해서는 <strong>Key</strong>값이 필수였다. 하지만 이 방법을 사용하면 처음에 key값을 알 수 없다. 따라서 영속성 컨텍스트에서 관리를 하기 위해서 INSERT SQL을 Entity Manager가 persist하자마자 날려주게 된다.(즉 버퍼링으로 모아서 Insert 불가)</p> <h3 id="sequence"><a href="#sequence" class="header-anchor">#</a> SEQUENCE</h3> <p>데이터베이스 시퀀스는 유일한 값을 순서대로 생성하는 특별한 DB의 Object를 의미한다. 이렇게 DB에서 시퀀스를 생성해서 넘겨주면 이것을 받아서 Id로 사용하는 전략이다.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@SequenceGenerator</span><span class="token punctuation">(</span>
	name <span class="token operator">=</span> <span class="token string">&quot;MEMBER_SEQ_GENERATOR&quot;</span><span class="token punctuation">,</span>
	sequenceName <span class="token operator">=</span> <span class="token string">&quot;MEMBER_SEQ&quot;</span><span class="token punctuation">,</span>
	initialValue <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
	allocationSize <span class="token operator">=</span> <span class="token number">50</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Member</span><span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Id</span>
	<span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>SEQUENCE<span class="token punctuation">,</span>
				generator <span class="token operator">=</span> <span class="token string">&quot;MEMBER_SEQ_GENERATOR&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>이렇게 Sequence Generator로 시퀀스를 생성해서 사용해준다. 만약  객체를 생성하여 persist해주면, DB에 있는 시퀀스 오브젝트를 불러 Id값을 가져온다. 따라서 INSERT SQL을 추후 트랜잭션이 커밋되는 상황에서 함께 날릴 수 있다.  문제는
DB에 항상 가서 Id값을 가져와야한다는 것이다. 이것을 방지하기 위하여  _allocationSize _를 정하여 해당 값만큼을 미리 당겨온다. 예를들어 이 값이 50이면 처음 1부터 생성할때 두번 DB에 방문하여(처음에 1 다음에 50더한 값) 51을 가져오고, 계속 persist되면서 더해진 객체의 ID가 51이 될 때 다시 DB에 가서 값을 세팅하는 과정을 거친다. <strong>이렇게 되면 DB에 접근하는 횟수를 줄일 수 있어 성능적으로 도움을 받을 수 있다.</strong> 동시성 문제를 고민할 필요 없이 사용할 수 있다. (만약 1번 서버가 1 ~ 50 구간을 사용하는데 2번 서버가 insert를 요청하면 51 ~ 101을 사용하도록 조치하여 넘겨주기 때문)</p> <h3 id="table"><a href="#table" class="header-anchor">#</a> TABLE</h3> <p>키를 생성하는 전용 테이블을 하나 생성해 DB의 시퀀스를 흉내내는 방법이다. 모든 DB에 적용이 가능하지만 성능에 대한 이슈가 있어 사용함에 있어 굉장히 부담스럽다.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> MY_SEQUENCES<span class="token punctuation">(</span>
	sequence_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
	next_val <span class="token keyword">bigint</span><span class="token punctuation">,</span>
	<span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span> sequence_name<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>이렇게 위에 처럼 테이블을 하나 생성하여 이 테이블을 키 값처럼 사용하는 것이다.
시퀀스 제너레이터를 사용하였듯이 테이블 제너레이터를 사용한다.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@TableGenerator</span><span class="token punctuation">(</span>
	name <span class="token operator">=</span> <span class="token string">&quot;MEMBER_SEQ_GENERATOR&quot;</span><span class="token punctuation">,</span>
	table <span class="token operator">=</span> <span class="token string">&quot;MY_SEQUENCES&quot;</span><span class="token punctuation">,</span>
	pkColumnValue <span class="token operator">=</span> <span class="token string">&quot;MEMBER_SEQ&quot;</span><span class="token punctuation">,</span> allocationSize <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Member</span><span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Id</span>
	<span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>TABLE<span class="token punctuation">,</span>
				generator <span class="token operator">=</span> <span class="token string">&quot;MEMBER_SEQ_GENERATOR&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>여기서 설명하는 allocationSize는 위에서 말한 것과 동일하다. 보통 50~100정도가 적당하다고 한다.</p> <h3 id="auto"><a href="#auto" class="header-anchor">#</a> AUTO</h3> <p>AUTO는 위 3개의 기능중에 하나를 자동으로 골라주는 전략이다.(DB의 방언을 고려해서 판단)</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/TIL/Docker/2022-02-12-20.html" class="prev">
        도커 시작하기
      </a></span> <span class="next"><a href="/TIL/JPA/2022-01-11.html">
        JPA 단방향 연관관계
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/TIL/assets/js/app.3f1ab354.js" defer></script><script src="/TIL/assets/js/2.a63aa0a0.js" defer></script><script src="/TIL/assets/js/15.2dffbb21.js" defer></script>
  </body>
</html>
